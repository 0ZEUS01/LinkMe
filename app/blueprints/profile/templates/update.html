{% extends 'full_base_navbar.html' %}
{% block title %}
    <title>Edit Profile</title>
{% endblock %}
{% block main %}
<style>
    .ui-autocomplete {
        max-width: 300px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .ui-autocomplete li {
        padding: 5px 10px;
        cursor: pointer;
    }

    .ui-autocomplete {
        background-color: #29333d;
        color: white;
        padding: 10px;
        margin: -5px -10px;
    }

    .selected-skills {
        list-style-type: none;
        padding: 0;
    }

    .selected-skills li {
        display: inline-block;
        margin-right: 15px;
        margin-top: 15px;
        background-color: #1458a0;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        position: relative;
    }

    .selected-skills li .close {
        position: absolute;
        right: -5px;
        top: -5px;
        background-color: white;
        color: #007bff;
        border: none;
        cursor: pointer;
        width: 20px;
        height: 20px;
        padding: 0;
        border-radius: 50%;
        font-size: 12px;
    }

    .selected-skills li .close:hover {
        background-color: #007bff;
        color: white;
    }
</style>
<div class="d-flex justify-content-center">
    <div class="container box-element m-3 border my-5 rounded-5" style="width:600px; max-height: 75vh; overflow-y: auto;background-color: #e6f5f3;">
        <div class="pt-3"><h4 class="text-dark text-center">Edit Your Profile</h4></div>
        <hr>
        <form method="post" enctype="multipart/form-data" action="{{ url_for('profile_blueprint.update_profile') }}">
            <div class="form-group">
                <label for="profile_pic" class="text-dark">Profile Picture</label>
                {% if user_details.profile_pic %}
                    <div class="mb-3">
                        <img src="{{ user_details.profile_pic }}" alt="Profile Picture" class="img-thumbnail" style="max-width: 150px;">
                    </div>
                {% else %}
                    <p>No profile picture uploaded.</p>
                {% endif %}
                <input type="file" class="form-control-file" id="profile_pic" name="profile_pic">
            </div>
            <hr>
            
            <div class="form-group">
                {% if user_details.experiences %}
                <h5><label for="experiences" class="text-dark">Experiences:</label></h5>
                <hr>
                {%endif%}
                <div id="experiences_container">
                    {% for experience in user_details.experiences %}
                        <div class="experience-item">
                            <div class="form-group">
                                <label class="text-secondary">Title</label>
                                <input type="text" class="form-control" name="experience_title" value="{{ experience.title }}" required>
                            </div>
                            <div class="form-group">
                                <label class="text-secondary">Description</label>
                                <textarea class="form-control" name="experience_description" rows="3">{{ experience.description }}</textarea>
                            </div>
                            <div class="form-group">
                                <label class="text-secondary">Start Date</label>
                                <input type="date" class="form-control" name="experience_start_date" value="{{ experience.start_date }}">
                            </div>
                            <div class="form-group">
                                <label class="text-secondary">End Date</label>
                                <input type="date" class="form-control" name="experience_end_date" value="{{ experience.end_date }}">
                            </div>
                            <button type="button" class="btn btn-danger remove_experience my-2">Remove Experience</button>
                            <hr>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-primary" id="add_experience">Add Experience</button>
            </div>
            <hr>
            
            <div class="form-group">
                <label for="skills" class="text-dark">Add Skills</label>
                <input type="text" id="skills" class="form-control" value="">
                <button type="button" class="btn btn-primary mt-2" id="add_skill">Add Skill</button>
                <span class="error text-danger"></span>
            </div>
            <hr>
            <input type="hidden" id="selectedSkillsInput" name="skills" required>
            
            <div class="form-group">
                <label>Your skills:</label>
                <ul class="selected-skills" id="selectedSkills"></ul>
            </div>
            
            <hr>
            <div class="pb-3 d-flex justify-content-center">
                <button type="submit" class="btn btn-primary rounded-5">Update Profile</button>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function() {
        var availableSkills = [];
        $.ajax({
            url: '/profile/skills',
            method: 'GET',
            success: function(data) {
                availableSkills = data;
                $("#skills").autocomplete({
                    source: function(request, response) {
                        var results = $.ui.autocomplete.filter(availableSkills, request.term);
                        response(results.slice(0, 2)); // Limit to 2 suggestions
                    },
                    minLength: 1,
                    select: function(event, ui) {
                        setTimeout(function() {
                            $("#skills").val("");
                        }, 100);
                        addSkill(ui.item.value);
                    },
                    appendTo: "#autocomplete-container",
                    position: { my: "left top", at: "left bottom", collision: "flip" }
                });
            },
            error: function() {
                console.error("Failed to fetch skills from server.");
            }
        });

        // Prepopulate selected skills from the user details
        var initialSkills = "{{ user_details.skills|join(',') }}".split(',');
        initialSkills.forEach(function(skill) {
            if (skill){
                addSkill(skill.trim());
            }
        });

        // Add custom skills on button click
        $("#add_skill").click(function() {
            var customSkill = $("#skills").val().trim();
            if (customSkill) {
                addSkill(customSkill);
                $("#skills").val(""); // Clear the input field
            }
        });

        // Function to add selected skill to the list
        function addSkill(skill) {
            var selectedSkills = $("#selectedSkills");
            var existingSkills = selectedSkills.find("li");

            if (!existingSkills.filter(function() {
                return $(this).text().trim().toLowerCase().replace(' ×', '') === skill.trim().toLowerCase();
            }).length) {
                selectedSkills.append('<li class="list-group-item">' + skill + ' <button type="button" class="close">&times;</button></li>');
                $('.error').html('');
            } else {
                $('.error').html(skill + ' is already selected');
            }

            updateHiddenInput();
        }

        // Event delegation for closing button
        $("#selectedSkills").on("click", ".close", function() {
            $(this).closest("li").remove();
            updateHiddenInput();
        });

        // Update hidden input with selected skills
        function updateHiddenInput() {
            var selectedSkills = $("#selectedSkills li").map(function() {
                return $(this).text().replace(' ×', '').trim();
            }).get().join(",");
            $("#selectedSkillsInput").val(selectedSkills);
            if (selectedSkills) {
                $('form button[type="submit"]').prop('disabled', false); // Enable submit button
            } else {
                $('form button[type="submit"]').prop('disabled', true); // Disable submit button
            }
        }

        // Function to add new experience input fields dynamically
        $("#add_experience").click(function() {
            var html = '<div class="experience-item"><div class="form-group"><label class="text-secondary">Title</label><input type="text" class="form-control" name="experience_title" required></div><div class="form-group"><label class="text-secondary">Description</label><textarea class="form-control" name="experience_description" rows="3"></textarea></div><div class="form-group"><label class="text-secondary">Start Date</label><input type="date" class="form-control" name="experience_start_date"></div><div class="form-group"><label class="text-secondary">End Date</label><input type="date" class="form-control" name="experience_end_date"></div><button type="button" class="btn btn-danger remove_experience my-2">Remove Experience</button><hr></div>';
            $("#experiences_container").append(html);
        });

        // Event delegation for removing experience fields
        $("#experiences_container").on("click", ".remove_experience", function() {
            $(this).closest(".experience-item").remove();
        });
    });
</script>
{% endblock %}
